import tkinter as tk
import sys
import requests
import shodan

def main(argv):
    def count():
        SHODAN_API_KEY = entry_APIKey.get()
        api = shodan.Shodan(SHODAN_API_KEY)
        try:
            results = api.search("http.title:ID_VC_Welcome")
            text_Total_Found.insert(tk.END, str(results['total']))
            button_Check = tk.Button(master=frame_top, text="CHECK", command=check)
            button_Check.grid(row=0, column=3, sticky="w")
            for result in results['matches']:
                server = result['ip_str']
                text_list.insert(tk.END, server + "\n")
        except shodan.APIError:
            text_Total_Found.replace('1.0', tk.END, 'Error: Shodan API Error')
    def check():
        protocol = 'https://'
        endpoint = '/ui/vropspluginui/rest/services/checkmobregister'
        vulnerable_count = 0
        tested_count = 0
        server_list = text_list.get("1.0", tk.END).splitlines()
        text_Total_Listed.replace("1.0", tk.END, len(server_list))
        text_Total_Listed.update()
        for server in server_list:
            tested_count = tested_count + 1
            url = protocol + server + endpoint
            try:
                r = requests.get(url, verify=False, timeout=(6.1))
            except:
                text_results.insert(tk.END, server + " did not respond\n")
                continue
            if r.status_code == 200:
                vulnerable_count = vulnerable_count + 1
                text_results.insert(tk.END, server + " is vulnerable!!!!!!!!!! - Status Code: " + str(r.status_code) + "\n")
                text_Total_Vulnerable.replace("1.0", tk.END, vulnerable_count)
            else:
                text_results.insert(tk.END, server + " is not vulnerable - Status Code: " + str(r.status_code) + "\n")
            text_Total_Tested.replace("1.0", tk.END, tested_count)
            text_Total_Tested.update()
            text_results.update()
            text_Total_Vulnerable.update()
    window = tk.Tk()
    window.title("Vulnerability Check - CVE_2021_21972")

    window.rowconfigure(0, minsize=10, weight=1)
    window.columnconfigure(1, minsize=10, weight=1)

    frame_top = tk.Frame(window, relief=tk.RAISED, bd=2, height=30, width=300, bg = 'powder blue')
    frame_middle = tk.Frame(window, relief=tk.RAISED, bd=2, height=285, width = 300, bg = 'powder blue')
    frame_bottom = tk.Frame(window, relief=tk.RAISED, bd=2, height=30, width=300, bg = 'powder blue')

    frame_top.grid(row=0, column=0, sticky="nesw")
    frame_middle.grid(row=1, column=0, sticky="ew")
    frame_bottom.grid(row=2, column=0, sticky="swe")

    #TOP FRAME
    label_APIKey = tk.Label(master=frame_top, text="Shodan API Key")
    entry_APIKey = tk.Entry(master=frame_top, width=40)
    button_Count = tk.Button(master=frame_top, text="COUNT", command=count)
    
    #TEMP
    entry_APIKey.insert(0, '----PUT API KEY HERE----')
    #TEMP

    label_APIKey.grid(row=0, column=0, sticky="w")
    entry_APIKey.grid(row=0, column=1, sticky="w")
    button_Count.grid(row=0, column=2, sticky="w")
 
    #MIDDLE FRAME
    text_list = tk.Text(master=frame_middle)
    text_list.grid(row=0, column=0, sticky="nesw")
    text_results = tk.Text(master=frame_middle)
    text_results.grid(row=0, column=1, sticky="nesw")

    #BOTTOM STATUS FRAME
    label_Total_Found = tk.Label(master=frame_bottom, text="Total Servers Found = ")
    text_Total_Found = tk.Text(master=frame_bottom, height=1, width=24)    
    label_Total_Listed = tk.Label(master=frame_bottom, text="Total Servers Listed = ")
    text_Total_Listed = tk.Text(master=frame_bottom, height=1, width=24)
    label_Total_Tested = tk.Label(master=frame_bottom, text="Total Servers Tested = ")
    text_Total_Tested = tk.Text(master=frame_bottom, height=1, width=24)
    label_Total_Vulnerable = tk.Label(master=frame_bottom, text="Total Servers Vulnerable= ")
    text_Total_Vulnerable = tk.Text(master=frame_bottom, height=1, width=24)
    
    label_Total_Found.grid(row=0, column=0, sticky="w")
    text_Total_Found.grid(row=0, column=1, sticky="w")
    label_Total_Listed.grid(row=0, column=2, sticky="w")
    text_Total_Listed.grid(row=0, column=3, sticky="w")
    label_Total_Tested.grid(row=0, column=4, sticky="w")
    text_Total_Tested.grid(row=0, column=5, sticky="w")
    label_Total_Vulnerable.grid(row=0, column=6, sticky="w")
    text_Total_Vulnerable.grid(row=0, column=7, sticky="w")

    window.mainloop()
if __name__ == "__main__":
    main(sys.argv[1:])